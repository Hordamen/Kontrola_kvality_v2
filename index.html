<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
  <title>Foto pozn√°mky ‚Äì Kontrola kvality</title>
  <link rel="manifest" href="manifest.json?v=2.2.9">
  <link rel="apple-touch-icon" href="icon192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="icon512.png" sizes="512x512">
  <link rel="icon" href="icon192.png" type="image/png" sizes="192x192">
  <link rel="icon" href="icon512.png" type="image/png" sizes="512x512">
  <meta name="theme-color" content="#1976d2">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="KvalitaFoto">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root{--brand:#1976d2;--muted:#666;--danger:#ff5252}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;padding:1rem;background:#f5f7fa;color:#111;max-width:1200px;margin:0 auto}
    .header{display:flex;gap:0.75rem;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap}
    .logo{width:56px;height:56px;object-fit:contain;border-radius:8px;flex-shrink:0}
    .header-text{flex:1;min-width:200px}
    h1{font-size:1.25rem;margin:0;color:var(--brand)}
    .subtitle{color:var(--muted);font-size:0.85rem;margin-top:4px}
    form{background:#fff;padding:1rem;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
    label{font-weight:600;display:block;margin-top:0.75rem;font-size:0.95rem;color:#333}
    input[type=file]{width:100%;padding:8px;border:2px dashed #e0e0e0;border-radius:8px;cursor:pointer;font-size:0.9rem}
    textarea{width:100%;min-height:64px;margin-top:6px;padding:10px;border-radius:8px;border:1px solid #e0e0e0;resize:vertical;font-family:inherit;font-size:0.95rem;transition:border-color 0.2s}
    textarea:focus{outline:none;border-color:var(--brand)}
    .form-actions{margin-top:1rem;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button{background:var(--brand);color:#fff;border:none;padding:10px 16px;border-radius:8px;font-weight:600;cursor:pointer;font-size:0.95rem;transition:opacity 0.2s}
    button:hover{opacity:0.9}
    button:disabled{opacity:0.5;cursor:not-allowed}
    .btn-secondary{background:#f1f3f6;color:#333}
    .btn-danger{background:var(--danger)}
    #status{margin-left:8px;color:var(--muted);font-size:0.9rem}
    .entries{margin-top:1.5rem;display:grid;gap:1rem}
    .entry{background:#fff;padding:1rem;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,0.04);display:grid;gap:1rem;transition:box-shadow 0.2s}
    .entry:hover{box-shadow:0 4px 12px rgba(0,0,0,0.08)}
    .entry-content{display:grid;grid-template-columns:140px 1fr;gap:1rem;align-items:start}
    .thumb{width:100%;height:100px;object-fit:cover;border-radius:8px;border:1px solid #e6eef9}
    .meta{display:flex;flex-direction:column;gap:8px}
    .meta-header{display:flex;justify-content:space-between;align-items:start;gap:8px;flex-wrap:wrap}
    .meta-header strong{font-size:0.95rem}
    .meta-info{color:var(--muted);font-size:0.85rem}
    .meta p{margin:0;font-size:0.9rem;color:#333;line-height:1.5}
    .meta p strong{color:#111;font-size:0.88rem}
    .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .btn-small{background:#f1f3f6;color:#333;padding:6px 12px;border-radius:6px;border:none;cursor:pointer;font-size:0.85rem;font-weight:500}
    .btn-small:hover{background:#e8eaed}
    .btn-small.danger{background:var(--danger);color:#fff}
    .btn-small.danger:hover{background:#e64545}
    .folders{margin-top:1.5rem;display:grid;gap:1rem;grid-template-columns:repeat(auto-fill, minmax(200px, 1fr))}
    .folder{background:#fff;padding:1rem;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,0.04);cursor:pointer;text-align:center;transition:box-shadow 0.2s}
    .folder:hover{box-shadow:0 4px 12px rgba(0,0,0,0.08)}
    .folder-name{font-weight:600;font-size:1.1rem;color:var(--brand)}
    .folder-count{font-size:0.9rem;color:var(--muted);margin-top:4px}
    footer{margin-top:2rem;padding-top:1rem;text-align:center;color:var(--muted);font-size:0.85rem;border-top:1px solid #e0e0e0}
    #viewer{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999}
    #viewer[aria-hidden="false"]{display:flex}
    #viewer-backdrop{position:absolute;inset:0;background:rgba(0,0,0,0.5)}
    #viewer-content{position:relative;max-width:1100px;width:100%;max-height:95vh;overflow:auto;background:#fff;border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,0.4)}
    #viewer-close{position:absolute;right:8px;top:8px;border:none;background:transparent;font-size:20px;cursor:pointer}
    #viewer-body img{max-width:100%;height:auto;border-radius:8px;border:1px solid #ddd;display:block;margin:12px 0}
    #viewer-body h1{font-size:1.6rem;color:var(--brand);margin:0 0 8px 0}
    #viewer-body .meta{font-size:1rem;color:var(--muted);margin-bottom:8px}
    #viewer-body .field{background:#f9f9f9;padding:12px;border-left:4px solid var(--brand);border-radius:6px;margin-top:10px}
    /* update banner */
    .update-banner{position:fixed;left:12px;right:12px;bottom:12px;background:#fff;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,0.18);padding:10px 12px;display:flex;align-items:center;gap:12px;z-index:10000}
    .update-banner .msg{flex:1;color:#111}
    .update-banner button{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .update-banner .primary{background:var(--brand);color:#fff}
    .update-banner .secondary{background:#f1f3f6;color:#333}
    @media (max-width:768px){body{padding:0.75rem}.thumb{height:80px}.entry-content{grid-template-columns:100px 1fr}}
  </style>
</head>
<body>
      <div class="header">
        <img src="icon2.png" alt="logo" class="logo" onerror="this.style.display='none'">
        <div class="header-text">
          <h1>Kontrola kvality ‚Äì Foto pozn√°mky</h1>
          <div class="subtitle">Fotka + pod√©ln√© & p≈ô√≠ƒçn√© mƒõ≈ôen√≠ + pozn√°mka + GPS + datum</div>
        </div>
      </div>

      <form id="noteForm">
        <label>Fotka (foto nebo galerie)</label>
        <input id="photo" type="file" accept="image/*" capture="camera">
        <label>Pod√©ln√© mƒõ≈ôen√≠</label>
        <textarea id="longNote" placeholder="Zadejte pod√©ln√© mƒõ≈ôen√≠..."></textarea>
        <label>P≈ô√≠ƒçn√© mƒõ≈ôen√≠</label>
        <textarea id="crossNote" placeholder="Zadejte p≈ô√≠ƒçn√© mƒõ≈ôen√≠..."></textarea>
        <label>Pozn√°mka</label>
        <textarea id="noteField" placeholder="Dopl≈àuj√≠c√≠ pozn√°mka..."></textarea>
        <label>Slo≈æka</label>
        <input id="folderName" placeholder="N√°zev slo≈æky (nepovinn√©)..." style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #e0e0e0; font-family: inherit; font-size: 0.95rem; margin-top: 6px;">
        <div class="form-actions">
          <button id="saveBtn" type="submit">Ulo≈æit z√°znam</button>
          <button id="show-map" type="button" style="background:var(--brand);color:#fff;">Zobrazit mapu z√°znam≈Ø</button>
          <button id="clearAll" type="button" class="btn-secondary">Vymazat v≈°e</button>
          <button id="exportBtn" type="button" class="btn-secondary">Exportovat data</button>
          <button id="importBtn" type="button" class="btn-secondary">Importovat data</button>
          <div id="status"></div>
          <input type="file" id="importFile" accept=".json" style="display: none;">
        </div>
      </form>

      <button id="backToFoldersBtn" type="button" class="btn-secondary" style="display: none; margin-top: 1rem;">Zpƒõt na slo≈æky</button>
      <section class="folders" id="folders"></section>
      <section class="entries" id="entries"></section>

      <!-- Map overlay -->
      <div id="map-overlay" aria-hidden="true" style="position:fixed;inset:0;display:none;z-index:99999;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;">
          <div id="map-content" style="position:relative;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.4);padding:16px;max-width:1100px;width:95vw;max-height:95vh;display:flex;flex-direction:column;">
            <button id="map-close" aria-label="Zav≈ô√≠t mapu" title="Zav≈ô√≠t mapu" style="position:absolute;right:12px;top:12px;background:var(--brand);color:#fff;border:none;width:36px;height:36px;border-radius:50%;font-size:18px;line-height:1;cursor:pointer;display:flex;align-items:center;justify-content:center;">‚úï</button>
          <h2 style="margin-top:0">Mapa z√°znam≈Ø</h2>
          <div id="map" style="width:100%;height:70vh;border-radius:8px;"></div>
        </div>
      </div>

      <div id="viewer" aria-hidden="true">
        <div id="viewer-backdrop"></div>
        <div id="viewer-content" role="dialog" aria-modal="true">
          <button id="viewer-close" aria-label="Zav≈ô√≠t">‚úï</button>
          <div id="viewer-body"></div>
          <div id="edit-map-container" style="display:none; margin-top: 1rem;">
            <div id="edit-map" style="height: 400px; width: 100%;"></div>
            <button id="save-coords-btn" class="btn-small" style="margin-top: 8px;">Ulo≈æit sou≈ôadnice</button>
          </div>
        </div>
      </div>

      <!-- update banner (hidden until new SW available) -->
      <div id="update-banner" class="update-banner" style="display:none">
        <div class="msg">Nov√° verze aplikace je dostupn√°.</div>
        <button id="update-now" class="primary">Aktualizovat</button>
        <button id="update-later" class="secondary">Pozdƒõji</button>
      </div>

      <footer>
        Aplikace funguje offline. Data jsou ulo≈æena lok√°lnƒõ v za≈ô√≠zen√≠ (IndexedDB).<br>
        <span style="color:var(--muted);font-size:0.95em;">Verze aplikace: v2.2.9</span>
      </footer>

      <script>
      // Lightweight IndexedDB helpers
      const DB_NAME = 'fotoPoznamkyDB';
      const DB_VERSION = 2;
      const STORE_NAME = 'entries';
      let db;

      function initDB(){
        return new Promise((res, rej)=>{
          const req = indexedDB.open(DB_NAME, DB_VERSION);
          req.onupgradeneeded = e => {
            const idb = e.target.result;
            if(!idb.objectStoreNames.contains(STORE_NAME)){
              const store = idb.createObjectStore(STORE_NAME,{keyPath:'id'});
              store.createIndex('time','time',{unique:false});
              store.createIndex('folder', 'folder', { unique: false });
            }
          };
          req.onsuccess = ()=>{ db = req.result; res(db); };
          req.onerror = ()=> rej(req.error);
        });
      }

      function addEntry(entry){
        return new Promise((res, rej)=>{
          const tx = db.transaction([STORE_NAME],'readwrite');
          const store = tx.objectStore(STORE_NAME);
          const r = store.add(entry);
          r.onsuccess = ()=> res(entry);
          r.onerror = ()=> rej(r.error);
        });
      }

      function updateEntry(entry) {
        return new Promise((res, rej) => {
          const tx = db.transaction([STORE_NAME], 'readwrite');
          const store = tx.objectStore(STORE_NAME);
          const r = store.put(entry);
          r.onsuccess = () => res(entry);
          r.onerror = () => rej(r.error);
        });
      }

      function getAllEntries(){
        return new Promise((res, rej)=>{
          const tx = db.transaction([STORE_NAME],'readonly');
          const store = tx.objectStore(STORE_NAME);
          const r = store.getAll();
          r.onsuccess = ()=>{
            const arr = r.result || [];
            arr.sort((a,b)=>b.time - a.time);
            res(arr);
          };
          r.onerror = ()=> rej(r.error);
        });
      }

      function deleteEntryById(id){
        return new Promise((res, rej)=>{
          const tx = db.transaction([STORE_NAME],'readwrite');
          const store = tx.objectStore(STORE_NAME);
          const r = store.delete(id);
          r.onsuccess = ()=> res();
          r.onerror = ()=> rej(r.error);
        });
      }

      function fileToBase64(file){
        return new Promise((res, rej)=>{
          const fr = new FileReader(); fr.onload = ()=> res(fr.result); fr.onerror = ()=> rej(fr.error); fr.readAsDataURL(file);
        });
      }

      function formatDate(ts){
        return new Date(ts).toLocaleString('cs-CZ', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
      }

      async function saveEntry(photoFile, longNote, crossNote, note, folderName){
        const coords = await (async ()=>{
          if(!('geolocation' in navigator)) return null;
          return new Promise(res=> navigator.geolocation.getCurrentPosition(p=>res({lat:p.coords.latitude.toFixed(6), lon:p.coords.longitude.toFixed(6)}), ()=>res(null), {enableHighAccuracy:true, timeout:8000}));
        })();
        const photoData = await fileToBase64(photoFile);
        const entry = { id:Date.now().toString(), time:Date.now(), timeText:formatDate(Date.now()), coords, longNote, crossNote, note, photo:photoData, folder:folderName };
        await addEntry(entry); return entry;
      }

      function escapeHtml(s){ return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

      function downloadPhoto(dataURL, id){ if(!dataURL){ alert('Fotografie nen√≠ dostupn√° pro sta≈æen√≠.'); return; } const a=document.createElement('a'); a.href=dataURL; a.download=`fotopoznamka_${id}.png`; document.body.appendChild(a); a.click(); a.remove(); }

      async function renderFoldersAndEntries(folderToShow = null) {
        const allEntries = await getAllEntries();
        const foldersEl = document.getElementById('folders');
        const entriesEl = document.getElementById('entries');
        const statusEl = document.getElementById('status');
        const backBtn = document.getElementById('backToFoldersBtn');

        foldersEl.innerHTML = '';
        entriesEl.innerHTML = '';

        if (folderToShow === null) {
            // FOLDERS VIEW
            backBtn.style.display = 'none';
            const folders = allEntries.reduce((acc, entry) => {
                const folderName = entry.folder || 'Bez slo≈æky';
                if (!acc[folderName]) {
                    acc[folderName] = 0;
                }
                acc[folderName]++;
                return acc;
            }, {});

            Object.keys(folders).sort().forEach(folderName => {
                const div = document.createElement('div');
                div.className = 'folder';
                
                const folderNameEl = document.createElement('div');
                folderNameEl.className = 'folder-name';
                folderNameEl.textContent = escapeHtml(folderName);
                folderNameEl.addEventListener('click', () => renderFoldersAndEntries(folderName));

                const folderCountEl = document.createElement('div');
                folderCountEl.className = 'folder-count';
                folderCountEl.textContent = `${folders[folderName]} ${folders[folderName] === 1 ? 'z√°znam' : 'z√°znamy'}`;

                const renameBtn = document.createElement('button');
                renameBtn.className = 'btn-small';
                renameBtn.textContent = 'P≈ôejmenovat';
                renameBtn.style.marginTop = '8px';
                renameBtn.onclick = async (e) => {
                    e.stopPropagation();
                    const newFolderName = prompt('Zadejte nov√Ω n√°zev slo≈æky:', folderName);
                    if (newFolderName && newFolderName.trim() && newFolderName.trim() !== folderName) {
                        const entriesToUpdate = allEntries.filter(entry => (entry.folder || 'Bez slo≈æky') === folderName);
                        for (const entry of entriesToUpdate) {
                            entry.folder = newFolderName.trim();
                            await updateEntry(entry);
                        }
                        await renderFoldersAndEntries();
                    }
                };
                
                div.appendChild(folderNameEl);
                div.appendChild(folderCountEl);
                div.appendChild(renameBtn);
                foldersEl.appendChild(div);
            });
            
            statusEl.textContent = `${Object.keys(folders).length} ${Object.keys(folders).length === 1 ? 'slo≈æka' : 'slo≈æky'}`;
            document.getElementById('noteForm').style.display = '';

        } else {
            // ENTRIES VIEW
            backBtn.style.display = 'block';
            foldersEl.innerHTML = `<h2>Slo≈æka: ${escapeHtml(folderToShow)}</h2>`;
            const entriesInFolder = allEntries.filter(e => (e.folder || 'Bez slo≈æky') === folderToShow);

            entriesInFolder.forEach(e => {
                const div = document.createElement('div');
                div.className = 'entry';
                const coordsText = e.coords ? `${e.coords.lat}, ${e.coords.lon}` : 'bez polohy';
                let notesHtml = '';
                if (e.longNote) notesHtml += `<p><strong>üìè Pod√©ln√© mƒõ≈ôen√≠:</strong> ${escapeHtml(e.longNote)}</p>`;
                if (e.crossNote) notesHtml += `<p><strong>‚ÜîÔ∏è P≈ô√≠ƒçn√© mƒõ≈ôen√≠:</strong> ${escapeHtml(e.crossNote)}</p>`;
                if (e.note) notesHtml += `<p><strong>üìù Pozn√°mka:</strong> ${escapeHtml(e.note)}</p>`;
                div.innerHTML = `<div class="entry-content"><img class="thumb" src="${e.photo}" alt="foto"><div class="meta"><div class="meta-header"><strong>${e.timeText}</strong><span class="meta-info">${coordsText}</span></div>${notesHtml}<div class="actions"><button class="btn-small view-btn" data-id="${e.id}">Zobrazit</button><button class="btn-small danger delete-btn" data-id="${e.id}">Smazat</button><button class="btn-small download-btn" data-id="${e.id}">St√°hnout foto</button><button class="btn-small move-btn" data-id="${e.id}">P≈ôesunout</button></div></div></div>`;
                div.querySelector('.view-btn').addEventListener('click', () => viewFull(e.id));
                div.querySelector('.delete-btn').addEventListener('click', async () => { if (confirm('Opravdu smazat tento z√°znam?')) { await deleteEntryById(e.id); await renderFoldersAndEntries(folderToShow); } });
                div.querySelector('.download-btn').addEventListener('click', () => downloadPhoto(e.photo, e.id));
                div.querySelector('.move-btn').addEventListener('click', async () => {
                    const allEntries = await getAllEntries();
                    const entryToMove = allEntries.find(entry => entry.id === e.id);
                    if (!entryToMove) {
                        alert('Z√°znam nebyl nalezen.');
                        return;
                    }

                    const existingFolders = [...new Set(allEntries.map(entry => entry.folder).filter(f => f && f.trim()))];
                    const currentFolder = entryToMove.folder || 'Bez slo≈æky';

                    const newFolderName = prompt(
                        `Kam chcete z√°znam p≈ôesunout?\n\nAktu√°ln√≠ slo≈æka: "${currentFolder}"\n\nZadejte n√°zev c√≠lov√© slo≈æky. M≈Ø≈æete zadat existuj√≠c√≠ nebo novou slo≈æku.\nExistuj√≠c√≠ slo≈æky: ${existingFolders.join(', ')}`,
                        currentFolder === 'Bez slo≈æky' ? '' : currentFolder
                    );

                    if (newFolderName !== null) {
                        const targetFolder = newFolderName.trim();
                        const sourceFolder = entryToMove.folder || '';
                        if (targetFolder !== sourceFolder) {
                             entryToMove.folder = targetFolder;
                             await updateEntry(entryToMove);
                             await renderFoldersAndEntries(folderToShow);
                             alert('Z√°znam byl p≈ôesunut.');
                        }
                    }
                });
                entriesEl.appendChild(div);
            });
            statusEl.textContent = `${entriesInFolder.length} ${entriesInFolder.length === 1 ? 'z√°znam' : 'z√°znamy'}`;
            document.getElementById('noteForm').style.display = 'none';
        }
    }
      
      async function render(){
        await renderFoldersAndEntries();
      }

      async function viewFull(id){
        const data = await getAllEntries(); const entry = data.find(d=>d.id===id); if(!entry){ alert('Z√°znam nenalezen'); return; }
        const viewer=document.getElementById('viewer'); const body=document.getElementById('viewer-body'); const coordsText = entry.coords?`${entry.coords.lat}, ${entry.coords.lon}`:'bez polohy';
        body.innerHTML = `
          <h1>Z√°znam z kontroly kvality</h1>
          <div class="meta"><strong>üìÖ ƒåas:</strong> ${entry.timeText} &nbsp; <strong>üìç Poloha:</strong> <span id="coords-display">${coordsText}</span></div>
          <img src="${entry.photo}" alt="Fotografie z√°znamu">
          ${entry.longNote?`<div class="field"><strong>üìè Pod√©ln√© mƒõ≈ôen√≠</strong><div class="field-value">${escapeHtml(entry.longNote)}</div></div>`:''}
          ${entry.crossNote?`<div class="field"><strong>‚ÜîÔ∏è P≈ô√≠ƒçn√© mƒõ≈ôen√≠</strong><div class="field-value">${escapeHtml(entry.crossNote)}</div></div>`:''}
          ${entry.note?`<div class="field"><strong>üìù Pozn√°mka</strong><div class="field-value">${escapeHtml(entry.note)}</div></div>`:''}
          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="viewer-download" class="btn-small">St√°hnout foto</button>
            <button id="edit-coords-btn" class="btn-small">Upravit sou≈ôadnice</button>
            <button id="viewer-delete" class="btn-small danger">Smazat z√°znam</button>
          </div>
          <footer>Kontrola kvality ‚Äì Foto pozn√°mky | ${new Date().toLocaleDateString('cs-CZ')}</footer>
        `;
        viewer.setAttribute('aria-hidden','false'); viewer.style.display='flex'; document.documentElement.style.overflow='hidden';
        
        const editMapContainer = document.getElementById('edit-map-container');
        const saveCoordsBtn = document.getElementById('save-coords-btn');
        let editMap;
        let marker;

        document.getElementById('edit-coords-btn').onclick = () => {
            editMapContainer.style.display = 'block';
            if (!editMap) {
                editMap = L.map('edit-map').setView(entry.coords ? [entry.coords.lat, entry.coords.lon] : [49.8, 15.5], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(editMap);
            }
            if (marker) {
                editMap.removeLayer(marker);
            }
            if (entry.coords) {
                marker = L.marker([entry.coords.lat, entry.coords.lon], { draggable: true }).addTo(editMap);
                editMap.setView([entry.coords.lat, entry.coords.lon], 16);
            } else {
                marker = L.marker(editMap.getCenter(), { draggable: true }).addTo(editMap);
                 editMap.setView([49.8, 15.5], 7);
            }
        };

        saveCoordsBtn.onclick = async () => {
            const newCoords = marker.getLatLng();
            entry.coords = { lat: newCoords.lat.toFixed(6), lon: newCoords.lng.toFixed(6) };
            await updateEntry(entry);
            document.getElementById('coords-display').textContent = `${entry.coords.lat}, ${entry.coords.lon}`;
            editMapContainer.style.display = 'none';
            alert('Sou≈ôadnice aktualizov√°ny.');
        };

        const closeViewer = () => {
            viewer.setAttribute('aria-hidden','true');
            viewer.style.display='none';
            document.documentElement.style.overflow='';
            editMapContainer.style.display = 'none';
            if (editMap) {
                editMap.remove();
                editMap = null;
            }
        };

        document.getElementById('viewer-close').onclick = closeViewer; 
        document.getElementById('viewer-backdrop').onclick = closeViewer;
        document.getElementById('viewer-download').onclick = ()=> downloadPhoto(entry.photo, entry.id);
        document.getElementById('viewer-delete').onclick = async ()=>{ if(confirm('Opravdu smazat tento z√°znam?')){ await deleteEntryById(entry.id); closeViewer(); await renderFoldersAndEntries(); }};
      }

      // Update-banner helpers
      function showUpdateBanner(reg){
        const banner = document.getElementById('update-banner'); banner.style.display = 'flex';
        const now = document.getElementById('update-now'); const later = document.getElementById('update-later');
        const onNow = async ()=>{
          banner.style.display='none';
          try{
            if(reg.waiting){ reg.waiting.postMessage({type:'SKIP_WAITING'}); }
          }catch(e){ console.warn('Failed to postMessage to SW', e); }
        };
        const onLater = ()=>{ banner.style.display='none'; };
        now.onclick = onNow; later.onclick = onLater;
      }

      // wire up form and registration
      document.addEventListener('DOMContentLoaded', async ()=>{
        await initDB(); 
        await renderFoldersAndEntries();
        
        document.getElementById('backToFoldersBtn').addEventListener('click', () => renderFoldersAndEntries());

        const mapOverlay = document.getElementById('map-overlay');
        const mapCloseBtn = document.getElementById('map-close');
        let mapInstance = null;

        // Map button handler
        setTimeout(()=>{
          const showMapBtn = document.getElementById('show-map');
          if(showMapBtn){
            showMapBtn.addEventListener('click', async ()=>{
              try{
                mapOverlay.setAttribute('aria-hidden','false');
                mapOverlay.style.display = 'flex';
                document.documentElement.style.overflow='hidden';
                // Wait a moment for DOM to render
                await new Promise(r => setTimeout(r, 100));
                // Get all entries with coords
                const entries = await getAllEntries();
                const points = entries.filter(e=>e.coords && e.coords.lat && e.coords.lon);
                // Init map only once
                if(!mapInstance){
                  mapInstance = L.map('map').setView([49.8, 15.5], 7);
                  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                  
                    attribution: 'Map data ¬© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
                    maxZoom: 18,
                  }).addTo(mapInstance);
                }
                // Invalidate size after showing
                mapInstance.invalidateSize();
                // Remove old markers
                mapInstance.eachLayer(layer => { if(layer instanceof L.Marker) mapInstance.removeLayer(layer); });
                // Add markers
                points.forEach(e=>{
                  const marker = L.marker([parseFloat(e.coords.lat), parseFloat(e.coords.lon)]).addTo(mapInstance);
                  marker.bindPopup(`<strong>${e.timeText}</strong><br>${e.longNote||''}<br>${e.crossNote||''}<br>${e.note||''}`);
                });
                if(points.length){
                  const bounds = L.latLngBounds(points.map(e=>[parseFloat(e.coords.lat), parseFloat(e.coords.lon)]));
                  mapInstance.fitBounds(bounds.pad(0.15));
                }
              }catch(err){
                console.error('Chyba mapy:', err);
                alert('Chyba p≈ôi otev√≠r√°n√≠ mapy: '+err.message);
              }
            });
          }
        }, 100);
        mapCloseBtn.onclick = ()=>{
          mapOverlay.setAttribute('aria-hidden','true');
          mapOverlay.style.display = 'none';
          document.documentElement.style.overflow='';
        };
        const form = document.getElementById('noteForm');
        form.addEventListener('submit', async (e)=>{ 
            e.preventDefault(); 
            const fileInput=document.getElementById('photo'); 
            if(!fileInput.files || fileInput.files.length===0){ alert('Vyberte fotografii.'); return; } 
            const longNote=document.getElementById('longNote').value.trim(); 
            const crossNote=document.getElementById('crossNote').value.trim(); 
            const note=document.getElementById('noteField').value.trim(); 
            const folderName = document.getElementById('folderName').value.trim();
            await saveEntry(fileInput.files[0], longNote, crossNote, note, folderName); 
            fileInput.value=''; 
            document.getElementById('longNote').value=''; 
            document.getElementById('crossNote').value=''; 
            document.getElementById('noteField').value=''; 
            document.getElementById('folderName').value='';
            await renderFoldersAndEntries(); 
            alert('Z√°znam ulo≈æen.'); 
        });

        document.getElementById('clearAll').addEventListener('click', async ()=>{ if(confirm('Opravdu vymazat v≈°echna data?')){ const tx=db.transaction([STORE_NAME],'readwrite'); tx.objectStore(STORE_NAME).clear(); tx.oncomplete = async ()=>{ await renderFoldersAndEntries(); }; }});
        document.getElementById('exportBtn').addEventListener('click', async ()=>{ const data = await getAllEntries(); const dateStr = new Date().toISOString().split('T')[0]; const a=document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:'application/json'})); a.download=`kontrolakvality_${dateStr}.json`; document.body.appendChild(a); a.click(); a.remove(); });
        document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('importFile').click());
        document.getElementById('importFile').addEventListener('change', async (ev)=>{ const f=ev.target.files[0]; if(!f) return; const txt = await f.text(); try{ const arr = JSON.parse(txt); for(const it of arr){ try{ await addEntry(it); }catch(e){} } await renderFoldersAndEntries(); alert('Import dokonƒçen.'); }catch(err){ alert('Chyba importu: '+err.message); } });

        // service worker registration + update handling (prompt user)
        if('serviceWorker' in navigator){
          try{
            const reg = await navigator.serviceWorker.register('service-worker.js');

            // If there's an already-waiting worker, prompt immediately
            if(reg.waiting){ showUpdateBanner(reg); }

            // When a new SW is found (installing) watch its state
            reg.addEventListener('updatefound', ()=>{
              const newWorker = reg.installing;
              if(!newWorker) return;
              newWorker.addEventListener('statechange', ()=>{
                if(newWorker.state === 'installed'){
                  // If there's a controller, it's an update. Prompt the user.
                  if(navigator.serviceWorker.controller){ showUpdateBanner(reg); }
                }
              });
            });

            // If the page receives a message from SW indicating activation, you can act
            navigator.serviceWorker.addEventListener('message', ev=>{
              if(!ev.data) return;
              if(ev.data.type === 'SW_ACTIVATED'){
                console.log('SW activated:', ev.data.cacheName);
              }
            });

            // When the new SW takes control, reload so clients use new assets
            navigator.serviceWorker.addEventListener('controllerchange', ()=>{
              if(window.__reloading) return; window.__reloading = true; window.location.reload();
            });

          }catch(err){ console.warn('SW registration failed', err); }
        }
      });
      </script>
    </body>
    </html>