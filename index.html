<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Foto pozn√°mky ‚Äì Kontrola kvality</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="icon512.png" sizes="512x512">
  <link rel="icon" href="icon192.png" type="image/png" sizes="192x192">
  <link rel="icon" href="icon512.png" type="image/png" sizes="512x512">
  <link rel="shortcut icon" href="icon192.png" type="image/png">
  <meta name="theme-color" content="#1976d2">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="KvalitaFoto">
  <style>
    :root{--brand:#1976d2;--muted:#666;--danger:#ff5252}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;padding:1rem;background:#f5f7fa;color:#111;max-width:1200px;margin:0 auto}
    
    .header{display:flex;gap:0.75rem;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap}
    .logo{width:56px;height:56px;object-fit:contain;border-radius:8px;flex-shrink:0}
    .header-text{flex:1;min-width:200px}
    h1{font-size:1.25rem;margin:0;color:var(--brand)}
    .subtitle{color:var(--muted);font-size:0.85rem;margin-top:4px}
    
    form{background:#fff;padding:1rem;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
    label{font-weight:600;display:block;margin-top:0.75rem;font-size:0.95rem;color:#333}
    label:first-of-type{margin-top:0}
    input[type=file]{width:100%;padding:8px;border:2px dashed #e0e0e0;border-radius:8px;cursor:pointer;font-size:0.9rem}
    input[type=file]:hover{border-color:var(--brand)}
    textarea{width:100%;min-height:64px;margin-top:6px;padding:10px;border-radius:8px;border:1px solid #e0e0e0;resize:vertical;font-family:inherit;font-size:0.95rem;transition:border-color 0.2s}
    textarea:focus{outline:none;border-color:var(--brand)}
    
    .form-actions{margin-top:1rem;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button{background:var(--brand);color:#fff;border:none;padding:10px 16px;border-radius:8px;font-weight:600;cursor:pointer;font-size:0.95rem;transition:opacity 0.2s}
    button:hover{opacity:0.9}
    button:disabled{opacity:0.5;cursor:not-allowed}
    .btn-secondary{background:#f1f3f6;color:#333}
    .btn-danger{background:var(--danger)}
    #status{margin-left:8px;color:var(--muted);font-size:0.9rem}
    
    .entries{margin-top:1.5rem;display:grid;gap:1rem}
    .entry{background:#fff;padding:1rem;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,0.04);display:grid;gap:1rem;transition:box-shadow 0.2s}
    .entry:hover{box-shadow:0 4px 12px rgba(0,0,0,0.08)}
    
    .entry-content{display:grid;grid-template-columns:140px 1fr;gap:1rem;align-items:start}
    .thumb{width:100%;height:100px;object-fit:cover;border-radius:8px;border:1px solid #e6eef9}
    .meta{display:flex;flex-direction:column;gap:8px}
    .meta-header{display:flex;justify-content:space-between;align-items:start;gap:8px;flex-wrap:wrap}
    .meta-header strong{font-size:0.95rem}
    .meta-info{color:var(--muted);font-size:0.85rem}
    .meta p{margin:0;font-size:0.9rem;color:#333;line-height:1.5}
    .meta p strong{color:#111;font-size:0.88rem}
    
    .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .btn-small{background:#f1f3f6;color:#333;padding:6px 12px;border-radius:6px;border:none;cursor:pointer;font-size:0.85rem;font-weight:500}
    .btn-small:hover{background:#e8eaed}
    .btn-small.danger{background:var(--danger);color:#fff}
    .btn-small.danger:hover{background:#e64545}
    
    footer{margin-top:2rem;padding-top:1rem;text-align:center;color:var(--muted);font-size:0.85rem;border-top:1px solid #e0e0e0}
    
    /* Responzivn√≠ design */
    @media (max-width: 768px){
      body{padding:0.75rem}
      h1{font-size:1.1rem}
      .subtitle{font-size:0.8rem}
      form{padding:0.875rem}
      .entry-content{grid-template-columns:100px 1fr;gap:0.75rem}
      .thumb{height:80px}
      .meta p{font-size:0.85rem}
    }
    
    @media (max-width: 480px){
      .header{gap:0.5rem}
      .logo{width:48px;height:48px}
      h1{font-size:1rem}
      .subtitle{font-size:0.75rem}
      .entry-content{grid-template-columns:1fr;gap:0.75rem}
      .thumb{width:100%;height:180px;object-fit:cover}
      .form-actions{flex-direction:column;align-items:stretch}
      .form-actions button{width:100%}
      #status{margin-left:0;margin-top:8px}
      .actions{width:100%}
      .btn-small{flex:1}
    }
    
    @media (min-width: 769px){
      .entries{grid-template-columns:repeat(auto-fill,minmax(500px,1fr))}
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="icon2.png" alt="logo" class="logo" onerror="this.style.display='none'">
    <div class="header-text">
      <h1>Kontrola kvality ‚Äì Foto pozn√°mky</h1>
      <div class="subtitle">Fotka + pod√©ln√© & p≈ô√≠ƒçn√© mƒõ≈ôen√≠ + pozn√°mka + GPS + datum</div>
    </div>
  </div>

  <form id="noteForm">
    <label>Fotka (foto nebo galerie)</label>
    <input id="photo" type="file" accept="image/*" capture="camera">
    
    <label>Pod√©ln√© mƒõ≈ôen√≠</label>
    <textarea id="longNote" placeholder="Zadejte pod√©ln√© mƒõ≈ôen√≠..."></textarea>
    
    <label>P≈ô√≠ƒçn√© mƒõ≈ôen√≠</label>
    <textarea id="crossNote" placeholder="Zadejte p≈ô√≠ƒçn√© mƒõ≈ôen√≠..."></textarea>
    
    <label>Pozn√°mka</label>
    <textarea id="noteField" placeholder="Dopl≈àuj√≠c√≠ pozn√°mka..."></textarea>
    
    <div class="form-actions">
      <button id="saveBtn" type="submit">Ulo≈æit z√°znam</button>
      <button id="clearAll" type="button" class="btn-secondary">Vymazat v≈°e</button>
      <button id="exportBtn" type="button" class="btn-secondary">Exportovat data</button>
      <button id="importBtn" type="button" class="btn-secondary">Importovat data</button>
      <div id="status"></div>
      <input type="file" id="importFile" accept=".json" style="display: none;">
    </div>
  </form>

  <section class="entries" id="entries"></section>

  <footer>Aplikace funguje offline. Data jsou ulo≈æena lok√°lnƒõ v za≈ô√≠zen√≠ (IndexedDB).</footer>

<script>
// IndexedDB setup
const DB_NAME = "fotoPoznamkyDB";
const DB_VERSION = 1;
const STORE_NAME = "entries";
let db;

function initDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onerror = () => reject(request.error);
    request.onsuccess = () => {
      db = request.result;
      resolve(db);
    };
    
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        const store = db.createObjectStore(STORE_NAME, { keyPath: "id" });
        store.createIndex("time", "time", { unique: false });
      }
    };
  });
}

function getAllEntries() {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([STORE_NAME], "readonly");
    const store = transaction.objectStore(STORE_NAME);
    const request = store.getAll();
    
    request.onsuccess = () => {
      const entries = request.result || [];
      entries.sort((a, b) => b.time - a.time);
      resolve(entries);
    };
    request.onerror = () => reject(request.error);
  });
}

function addEntry(entry) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([STORE_NAME], "readwrite");
    const store = transaction.objectStore(STORE_NAME);
    const request = store.add(entry);
    
    request.onsuccess = () => resolve(entry);
    request.onerror = () => reject(request.error);
  });
}

function deleteEntryById(id) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([STORE_NAME], "readwrite");
    const store = transaction.objectStore(STORE_NAME);
    const request = store.delete(id);
    
    request.onsuccess = () => resolve();
    request.onerror = () => reject(request.error);
  });
}

function clearAllEntries() {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([STORE_NAME], "readwrite");
    const store = transaction.objectStore(STORE_NAME);
    const request = store.clear();
    
    request.onsuccess = () => resolve();
    request.onerror = () => reject(request.error);
  });
}

// Helper functions
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function formatDate(ts) {
  return new Date(ts).toLocaleString('cs-CZ', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

async function getCurrentPosition(timeout = 10000) {
  return new Promise(resolve => {
    if (!("geolocation" in navigator)) {
      resolve(null);
      return;
    }
    let done = false;
    navigator.geolocation.getCurrentPosition(
      pos => {
        if (done) return;
        done = true;
        resolve({
          lat: pos.coords.latitude.toFixed(6),
          lon: pos.coords.longitude.toFixed(6)
        });
      },
      err => {
        if (done) return;
        done = true;
        resolve(null);
      },
      { enableHighAccuracy: true, timeout: timeout, maximumAge: 60000 }
    );
    setTimeout(() => {
      if (!done) {
        done = true;
        resolve(null);
      }
    }, timeout + 200);
  });
}

async function saveEntry(photoFile, longNote, crossNote, note) {
  const coords = await getCurrentPosition();
  const photoData = await fileToBase64(photoFile);
  const entry = {
    id: Date.now().toString(),
    time: Date.now(),
    timeText: formatDate(Date.now()),
    coords,
    longNote,
    crossNote,
    note,
    photo: photoData
  };
  await addEntry(entry);
  return entry;
}

function downloadPhoto(dataURL, id) {
  if (!dataURL || dataURL.startsWith('data:,') || dataURL.startsWith('data:;')) {
    alert("Fotografie nen√≠ dostupn√° pro sta≈æen√≠.");
    return;
  }
  const a = document.createElement('a');
  a.href = dataURL; 
  a.download = `fotopoznamka_QK_${id}.png`; 
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

async function render() {
  const data = await getAllEntries();
  const entriesEl = document.getElementById("entries");
  const statusEl = document.getElementById("status");
  
  entriesEl.innerHTML = "";
  data.forEach(e => {
    const div = document.createElement("div");
    div.className = "entry";
    
    const coordsText = e.coords ? `${e.coords.lat}, ${e.coords.lon}` : "bez polohy";
    
    div.innerHTML = `
      <div class="entry-content">
        <img class="thumb" src="${e.photo}" alt="foto">
        <div class="meta">
          <div class="meta-header">
            <strong>${e.timeText}</strong>
            <span class="meta-info">${coordsText}</span>
          </div>
          ${e.longNote ? `<p><strong>Pod√©ln√© mƒõ≈ôen√≠:</strong> ${escapeHtml(e.longNote)}</p>` : ''}
          ${e.crossNote ? `<p><strong>P≈ô√≠ƒçn√© mƒõ≈ôen√≠:</strong> ${escapeHtml(e.crossNote)}</p>` : ''}
          ${e.note ? `<p><strong>Pozn√°mka:</strong> ${escapeHtml(e.note)}</p>` : ''}
          <div class="actions">
            <button class="btn-small view-btn" data-id="${e.id}">Zobrazit</button>
            <button class="btn-small danger delete-btn" data-id="${e.id}">Smazat</button>
            <button class="btn-small download-btn" data-id="${e.id}">St√°hnout foto</button> 
          </div>
        </div>
      </div>`;
    
    const buttons = div.querySelectorAll(".actions button");
    buttons[0].addEventListener("click", () => viewFull(e.id));
    buttons[1].addEventListener("click", () => deleteEntry(e.id));
    
    const downloadBtn = buttons[2];
    if (downloadBtn) {
        downloadBtn.addEventListener("click", () => downloadPhoto(e.photo, e.id));
    }

    entriesEl.appendChild(div);
  });
  
  statusEl.textContent = data.length ? `${data.length} ${data.length === 1 ? 'z√°znam' : data.length < 5 ? 'z√°znamy' : 'z√°znam≈Ø'}` : "≈æ√°dn√© z√°znamy";
}

function escapeHtml(s) {
  return (s || "").replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;");
}

async function deleteEntry(id) {
  if (!confirm("Opravdu smazat tento z√°znam?")) return;
  await deleteEntryById(id);
  await render();
}

async function viewFull(id) {
  const data = await getAllEntries();
  const entry = data.find(d => d.id === id);
  if (!entry) {
    alert("Z√°znam nenalezen");
    return;
  }
  const w = window.open("", "_blank");
  w.document.write(`
    <!DOCTYPE html>
    <html lang="cs">
    <head>
      <meta charset="utf-8">
      <title>Z√°znam - ${entry.timeText}</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
      <style>
        * { box-sizing: border-box; }
        html { font-size: 16px; }
        body {
          font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
          margin: 0;
          padding: 1rem;
          background: #f5f7fa;
          color: #111;
        }
        .container {
          max-width: 900px;
          margin: 0 auto;
          background: #fff;
          border-radius: 12px;
          padding: 1.5rem;
          box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .header {
          margin-bottom: 1.5rem;
          border-bottom: 2px solid #e0e0e0;
          padding-bottom: 1rem;
        }
        .header h1 {
          margin: 0 0 0.5rem 0;
          font-size: 1.5rem;
          color: #1976d2;
        }
        .header .meta {
          font-size: 0.95rem;
          color: #666;
          line-height: 1.6;
        }
        .photo-container {
          margin: 1.5rem 0;
          text-align: center;
        }
        img {
          max-width: 100%;
          height: auto;
          border-radius: 8px;
          border: 1px solid #e0e0e0;
          display: block;
        }
        .content {
          margin-top: 1.5rem;
        }
        .field {
          margin-bottom: 1.25rem;
          padding: 1rem;
          background: #f9f9f9;
          border-left: 4px solid #1976d2;
          border-radius: 4px;
        }
        .field strong {
          color: #1976d2;
          font-weight: 600;
          display: block;
          margin-bottom: 0.5rem;
          font-size: 1.05rem;
        }
        .field-value {
          color: #333;
          font-size: 1rem;
          line-height: 1.6;
          word-break: break-word;
          white-space: pre-wrap;
        }
        .empty-field {
          color: #999;
          font-style: italic;
        }
        footer {
          margin-top: 2rem;
          padding-top: 1rem;
          border-top: 1px solid #e0e0e0;
          text-align: center;
          font-size: 0.85rem;
          color: #666;
        }
        /* Tablet optimalizace */
        @media (max-width: 768px) {
          html { font-size: 14px; }
          body { padding: 0.75rem; }
          .container { padding: 1rem; }
          .header h1 { font-size: 1.3rem; }
          img { border-radius: 6px; }
          .field { padding: 0.875rem; margin-bottom: 1rem; }
        }
        /* Mobiln√≠ optimalizace */
        @media (max-width: 480px) {
          html { font-size: 13px; }
          body { padding: 0.5rem; }
          .container { padding: 0.875rem; border-radius: 8px; }
          .header h1 { font-size: 1.1rem; margin-bottom: 0.75rem; }
          .header .meta { font-size: 0.9rem; }
          .photo-container { margin: 1rem 0; }
          img { border-radius: 6px; max-height: 70vh; width: auto; }
          .field { padding: 0.75rem; margin-bottom: 0.875rem; border-left-width: 3px; }
          .field strong { font-size: 1rem; }
          .field-value { font-size: 0.95rem; }
          footer { font-size: 0.8rem; margin-top: 1.5rem; }
        }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>Z√°znam z kontroly kvality</h1>
          <div class="meta">
            <strong>üìÖ ƒåas:</strong> ${entry.timeText}<br>
            <strong>üìç Poloha:</strong> ${entry.coords ? entry.coords.lat + ", " + entry.coords.lon : "bez polohy"}
          </div>
        </div>
        
        <div class="photo-container">
          <img src="${entry.photo}" alt="Fotografie z√°znamu">
        </div>
        
        <div class="content">
          ${entry.longNote ? `
            <div class="field">
              <strong>üìè Pod√©ln√© mƒõ≈ôen√≠</strong>
              <div class="field-value">${escapeHtml(entry.longNote)}</div>
            </div>
          ` : ''}
          
          ${entry.crossNote ? `
            <div class="field">
              <strong>‚ÜîÔ∏è P≈ô√≠ƒçn√© mƒõ≈ôen√≠</strong>
              <div class="field-value">${escapeHtml(entry.crossNote)}</div>
            </div>
          ` : ''}
          
          ${entry.note ? `
            <div class="field">
              <strong>üìù Pozn√°mka</strong>
              <div class="field-value">${escapeHtml(entry.note)}</div>
            </div>
          ` : ''}
          
          ${!entry.longNote && !entry.crossNote && !entry.note ? `
            <div class="field">
              <div class="field-value empty-field">Bez dal≈°√≠ch informac√≠</div>
            </div>
          ` : ''}
        </div>
        
        <footer>Kontrola kvality ‚Äì Foto pozn√°mky | ${new Date().toLocaleDateString('cs-CZ')}</footer>
      </div>
    </body>
    </html>
  `);
}

// Export and Import functions
async function exportData() {
  const entries = await getAllEntries();
  if (entries.length === 0) {
    alert("Nen√≠ co exportovat.");
    return;
  }

  const jsonData = JSON.stringify(entries, null, 2);
  const blob = new Blob([jsonData], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  const date = new Date().toISOString().split('T')[0];
  a.download = `futtec_kontrola_kvality_export_${date}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function importData(file) {
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async (event) => {
    try {
      const importedEntries = JSON.parse(event.target.result);
      if (!Array.isArray(importedEntries)) {
        throw new Error("Importovan√Ω soubor nem√° spr√°vn√Ω form√°t (nen√≠ pole).");
      }

      if (!confirm(`Opravdu chcete importovat ${importedEntries.length} z√°znam≈Ø? St√°vaj√≠c√≠ z√°znamy s duplicitn√≠m ID budou p≈ôeskoƒçeny.`)) {
        return;
      }

      const existingEntries = await getAllEntries();
      const existingIds = new Set(existingEntries.map(e => e.id));
      const newEntries = importedEntries.filter(entry => !existingIds.has(entry.id));

      for (const entry of newEntries) {
        await addEntry(entry);
      }
      alert(`Import dokonƒçen. P≈ôid√°no ${newEntries.length} nov√Ωch z√°znam≈Ø.`);
      await render();
    } catch (error) {
      alert("Chyba p≈ôi importu dat: " + error.message);
    }
  };
  reader.readAsText(file);
}

// Form submission
const form = document.getElementById("noteForm");
form.addEventListener("submit", async (ev) => {
  ev.preventDefault();
  const photoInput = document.getElementById("photo");
  const file = photoInput.files[0];
  if (!file) {
    alert("Vyber fotku!");
    return;
  }
  const longNote = document.getElementById("longNote").value;
  const crossNote = document.getElementById("crossNote").value;
  const note = document.getElementById("noteField").value;
  
  try {
    document.getElementById("saveBtn").disabled = true;
    document.getElementById("status").textContent = "Ukl√°d√°m...";
    await saveEntry(file, longNote, crossNote, note);
    form.reset();
    await render();
  } catch (err) {
    alert("Chyba p≈ôi ukl√°d√°n√≠: " + err);
  } finally {
    document.getElementById("saveBtn").disabled = false;
    document.getElementById("status").textContent = "";
  }
});

// Clear all button
const clearAllBtn = document.getElementById("clearAll");
clearAllBtn.addEventListener("click", async () => {
  if (!confirm("Smazat V≈†ECHNY z√°znamy? Tuto akci nelze vr√°tit.")) return;
  await clearAllEntries();
  await render();
});

// Export button
const exportBtn = document.getElementById("exportBtn");
exportBtn.addEventListener("click", exportData);

// Import button and file input
const importBtn = document.getElementById("importBtn");
const importFile = document.getElementById("importFile");
importBtn.addEventListener("click", () => {
  importFile.click();
});
importFile.addEventListener("change", (event) => {
  importData(event.target.files[0]);
});

// Service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js').catch(() => {});
}

// Initialize app
initDB().then(() => {
  render();
}).catch(err => {
  alert("Chyba p≈ôi inicializaci datab√°ze: " + err);
});
</script>
</body>
</html>